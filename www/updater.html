<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Softwareupdate</title>
    <link rel="stylesheet" href="data/styles/dashboard.css">
    <link rel="stylesheet" href="data/styles/global-theme.css">
    <style>
        /* Status Container (Center) */
        .update-status-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            min-height: 200px;
        }
        .status-icon-large {
            width: 80px;
            height: 80px;
            color: var(--secondary-text-color);
            margin-bottom: 20px;
            opacity: 0.5;
            transition: color 0.3s;
        }
        .status-icon-large.success { color: var(--accent-color); opacity: 1; }
        .status-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .status-desc { font-size: 15px; color: var(--secondary-text-color); max-width: 300px; line-height: 1.4; }

        /* New Update Card */
        .update-card {
            background: linear-gradient(135deg, var(--card-background) 0%, var(--background-color) 100%);
            border: 1px solid var(--accent-color);
            padding: 24px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .update-card::before {
            content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: var(--accent-color);
        }
        .update-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        
        .version-badge {
            background: var(--accent-color);
            color: var(--accent-color);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 4px 10px var(--accent-bg);
        }
        
        .changelog-box {
            background: rgba(128, 128, 128, 0.08);
            padding: 16px;
            border-radius: 16px;
            margin: 20px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px; line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        /* Version List */
        .version-list { display: flex; flex-direction: column; gap: 12px; }
        .version-card {
            background: var(--card-background);
            padding: 16px;
            border-radius: var(--card-radius);
            display: flex; align-items: center; justify-content: space-between;
            border: 1px solid transparent;
            transition: transform 0.2s;
        }
        .version-card.active {
            border-color: var(--accent-color);
            background: var(--accent-bg);
        }
        .v-info { display: flex; flex-direction: column; }
        .v-title { font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .v-meta { font-size: 13px; color: var(--secondary-text-color); margin-top: 2px; }
        
        .active-tag {
            font-size: 11px; color: var(--accent-color);
            background: rgba(255,255,255,0.5);
            padding: 2px 8px; border-radius: 6px;
        }
        
        /* Beta Card Special */
        .beta-card {
            border-color: #ff9500 !important;
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, var(--background-color) 100%) !important;
        }
    </style>
</head>
<body class="no-layout-change">
    <div class="app">
        <header class="header">
            <a href="settings.html" class="back-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </a>
            <h1>Softwareupdate</h1>
            <p>Versionen verwalten</p>
        </header>
        <main class="content">

            <!-- Status Container -->
            <div id="status-container" class="update-status-container">
                <svg id="status-icon" class="status-icon-large spinning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                <div id="status-title" class="status-title">Suche nach Updates...</div>
                <div id="status-desc" class="status-desc">Bitte warten</div>
                <button id="check-again-btn" class="btn-secondary" style="margin-top: 20px; display: none;">Erneut prüfen</button>
            </div>

            <!-- New Update Section -->
            <div id="new-update-card" class="card update-card" style="display: none;">
                <div class="update-header">
                    <div><h2 style="margin: 0; font-size: 22px;">Update verfügbar</h2><p style="margin: 5px 0 0 0; opacity: 0.7;">Neue Funktionen & Verbesserungen</p></div>
                    <div class="version-badge" id="new-version-badge">vX.X.X</div>
                </div>
                <div class="changelog-box" id="new-version-changelog"></div>
                <button id="install-update-btn" class="btn-primary" style="width: 100%; padding: 16px; font-size: 16px;">Jetzt installieren</button>
            </div>

            <!-- Beta Section -->
            <div id="beta-section" style="display: none; margin-bottom: 30px;">
                <h3 style="margin: 0 0 15px 5px; opacity: 0.6; text-transform: uppercase; font-size: 13px; letter-spacing: 1px; color: #ff9500;">Beta / Experimentell</h3>
                <div id="beta-card-content" class="card update-card beta-card">
                    <!-- populated by JS -->
                </div>
            </div>

            <!-- Server History Section -->
            <h3 style="margin: 30px 0 15px 5px; opacity: 0.6; text-transform: uppercase; font-size: 13px; letter-spacing: 1px;">Verfügbar auf Server</h3>
            <div id="server-list" class="version-list" style="margin-bottom: 30px;"></div>

            <!-- Installed Versions Section -->
            <h3 style="margin: 30px 0 15px 5px; opacity: 0.6; text-transform: uppercase; font-size: 13px; letter-spacing: 1px;">Installierte Versionen</h3>
            <div id="version-list" class="version-list">
                <!-- JS populates this -->
            </div>
        </main>
    </div>

    <script src="data/scripts/theme-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const newUpdateCard = document.getElementById('new-update-card');
            const statusContainer = document.getElementById('status-container');
            const statusIcon = document.getElementById('status-icon');
            const statusTitle = document.getElementById('status-title');
            const statusDesc = document.getElementById('status-desc');
            const checkAgainBtn = document.getElementById('check-again-btn');
            
            const versionList = document.getElementById('version-list');
            const serverList = document.getElementById('server-list');
            const betaSection = document.getElementById('beta-section');
            const installBtn = document.getElementById('install-update-btn');

            const CapacitorUpdater = window.getCapacitorUpdater();
            let newUpdateData = null;

            async function renderInstalledVersions() {
                versionList.innerHTML = '<div style="padding: 40px; text-align: center;"><svg class="spinning" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--secondary-text-color);"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg></div>';
                if (!CapacitorUpdater) {
                    versionList.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.6;">Updater-Plugin nicht verfügbar.</div>';
                    return;
                }
                try {
                    const list = await CapacitorUpdater.list();
                    const current = await CapacitorUpdater.current();
                    versionList.innerHTML = ''; // Spinner entfernen

                    const originalVersionItem = document.createElement('div');
                    originalVersionItem.className = `version-card ${!current.id ? 'active' : ''}`;
                    originalVersionItem.innerHTML = `
                        <div class="v-info">
                            <div class="v-title">Original-Version ${!current.id ? '<span class="active-tag">Aktiv</span>' : ''}</div>
                            <div class="v-meta">Basis-App <span class="app-version"></span></div>
                        </div>
                        ${current.id ? '<button class="btn-secondary">Aktivieren</button>' : ''}
                    `;
                    if (current.id) {
                        originalVersionItem.querySelector('button').onclick = async () => {
                            await CapacitorUpdater.reset();
                            window.location.reload();
                        };
                    }
                    versionList.appendChild(originalVersionItem);

                    if (!list.versions || list.versions.length === 0) return;

                    list.versions.forEach(v => {
                        const isActive = v.id === current.id;
                        const item = document.createElement('div');
                        item.className = `version-card ${isActive ? 'active' : ''}`;
                        item.innerHTML = `
                            <div class="v-info">
                                <div class="v-title">Version ${v.version} ${isActive ? '<span class="active-tag">Aktiv</span>' : ''}</div>
                                <div class="v-meta">Heruntergeladen am ${v.downloaded ? new Date(v.downloaded).toLocaleDateString() : 'Unbekannt'}</div>
                            </div>
                            ${!isActive ? '<button class="btn-secondary">Aktivieren</button>' : ''}
                        `;
                        if (!isActive) {
                            item.querySelector('button').onclick = async () => {
                                item.querySelector('button').textContent = '...';
                                await CapacitorUpdater.set(v);
                                window.location.reload();
                            };
                        }
                        versionList.appendChild(item);
                    });
                } catch (e) {
                    versionList.innerHTML = `<div style="padding: 20px; color: #ff3b30;">Fehler: ${e.message}</div>`;
                }
            }

            async function checkForNewUpdate() {
                statusIcon.classList.add('spinning');
                statusIcon.innerHTML = '<path d="M21 12a9 9 0 1 1-6.219-8.56"/>'; // Spinner path
                statusTitle.textContent = 'Suche nach Updates...';
                statusDesc.textContent = 'Bitte warten';
                checkAgainBtn.style.display = 'none';
                newUpdateCard.style.display = 'none';
                statusContainer.style.display = 'flex';

                try {
                    // Hole das komplette Manifest (inkl. History & Beta)
                    const manifest = await window.fetchUpdateManifest();
                    
                    // 1. Check Stable Update
                    // Wir nutzen window.rxCompareVersions aus theme-manager.js
                    const currentVer = document.querySelector('.app-version').textContent;
                    
                    if (window.rxCompareVersions(manifest.version, currentVer) > 0) {
                        newUpdateData = manifest;
                        document.getElementById('new-version-badge').textContent = `v${manifest.version}`;
                        document.getElementById('new-version-changelog').textContent = manifest.changelog || 'Keine Informationen verfügbar.';
                        newUpdateCard.style.display = 'block';
                        statusContainer.style.display = 'none';
                    } else {
                        showStatusSuccess('Deine App ist aktuell', 'Es sind keine neuen Updates verfügbar.');
                    }

                    // 2. Check Beta
                    if (manifest.beta) {
                        betaSection.style.display = 'block';
                        const betaCard = document.getElementById('beta-card-content');
                        betaCard.innerHTML = `
                            <div class="update-header">
                                <div><h2 style="margin: 0; font-size: 20px; color: #ff9500;">Beta ${manifest.beta.version}</h2></div>
                                <div class="version-badge" style="background:#ff9500;">BETA</div>
                            </div>
                            <div class="changelog-box" style="border-color: #ff9500;">${manifest.beta.changelog || 'Keine Infos'}</div>
                            <button class="btn-secondary" style="width:100%; color:#ff9500;" onclick='installCustom("${manifest.beta.url}", "${manifest.beta.version}", ${JSON.stringify(manifest.beta.changelog || "")})'>Beta Installieren</button>
                        `;
                    }

                    // 3. Render Server History
                    if (manifest.releases && Array.isArray(manifest.releases)) {
                        serverList.innerHTML = '';
                        manifest.releases.forEach(rel => {
                            // Überspringe die allerneueste, wenn sie schon oben als "Update verfügbar" angezeigt wird
                            if (newUpdateData && rel.version === newUpdateData.version) return;

                            const item = document.createElement('div');
                            item.className = 'version-card';
                            item.innerHTML = `
                                <div class="v-info">
                                    <div class="v-title">v${rel.version}</div>
                                    <div class="v-meta">Release</div>
                                </div>
                                <button class="btn-secondary">Laden</button>
                            `;
                            item.querySelector('button').onclick = () => {
                                installCustom(rel.url, rel.version, rel.changelog);
                            };
                            serverList.appendChild(item);
                        });
                    }
                } catch (e) {
                    statusIcon.classList.remove('spinning');
                    statusTitle.textContent = 'Prüfung fehlgeschlagen';
                    statusDesc.textContent = 'Bitte überprüfe deine Internetverbindung.';
                    checkAgainBtn.style.display = 'inline-block';
                }
            }

            function showStatusSuccess(title, desc) {
                statusIcon.classList.remove('spinning');
                statusIcon.classList.add('success');
                statusIcon.innerHTML = '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'; // Checkmark
                statusTitle.textContent = title;
                statusDesc.textContent = desc;
                checkAgainBtn.style.display = 'inline-block';
            }

            // Globale Funktion für Button-Klicks (Beta/History)
            window.installCustom = (url, version, changelog) => {
                const data = { url, version, changelog };
                if(confirm(`Möchtest du Version ${version} wirklich installieren?`)) {
                    // Startet Update sofort
                    window.checkForOTAUpdates(false, data, true);
                }
            };

            installBtn.addEventListener('click', () => {
                if (newUpdateData) {
                    // Wir rufen die globale Funktion auf, die die UI-Updates (Benachrichtigung etc.) handhabt
                    window.checkForOTAUpdates(false, newUpdateData, true);
                }
            });
            
            checkAgainBtn.addEventListener('click', checkForNewUpdate);

            renderInstalledVersions();
            checkForNewUpdate();
        });
    </script>
</body>
</html>